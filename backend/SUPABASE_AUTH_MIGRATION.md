# Supabase Auth Migration Guide

**Date:** January 11, 2026  
**Status:** ‚úÖ Migration Complete

---

## Overview

We've migrated from custom JWT authentication to **Supabase Auth**. This provides:
- ‚úÖ Built-in password reset
- ‚úÖ Email verification
- ‚úÖ OAuth providers (Google, GitHub, etc.)
- ‚úÖ Magic links
- ‚úÖ Better security (battle-tested)
- ‚úÖ Less code to maintain

---

## What Changed

### Backend Changes

1. **`app/core/supabase_auth.py`** (NEW)
   - JWT token validation using Supabase client
   - JWKS fetching and caching
   - Token verification logic

2. **`app/core/dependencies.py`** (UPDATED)
   - `get_current_user()` now validates Supabase JWT tokens
   - Automatically syncs users from `auth.users` to `public.users`

3. **`app/services/user_service.py`** (UPDATED)
   - Added `sync_user_from_supabase()` method
   - Syncs user data when first API call is made

4. **`app/api/routes/auth.py`** (DEPRECATED)
   - Custom signup/login endpoints removed
   - Supabase handles authentication on frontend

### What Was Removed

- ‚ùå Custom password hashing (Supabase handles it)
- ‚ùå Custom JWT generation (Supabase generates tokens)
- ‚ùå Signup/login endpoints (use Supabase client on frontend)

---

## How It Works

### Frontend (Next.js)

Users sign up and log in using Supabase client:

```typescript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
)

// Sign up
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'SecurePassword123!',
  options: {
    data: {
      full_name: 'John Doe',
      language: 'en'
    }
  }
})

// Sign in
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'SecurePassword123!'
})

// Get session token
const { data: { session } } = await supabase.auth.getSession()
const token = session?.access_token
```

### Backend (FastAPI)

Backend validates Supabase JWT tokens:

```python
from app.core.dependencies import get_current_user

@router.get("/protected")
async def protected_route(
    current_user: User = Depends(get_current_user)
):
    # current_user is automatically available
    # Token was validated and user was synced from Supabase
    return {"user_id": current_user.id}
```

---

## User Sync Flow

1. **User signs up** via Supabase Auth (frontend)
   - User created in `auth.users` table
   - JWT token generated by Supabase

2. **User makes API call** with token
   - Backend validates token using `verify_supabase_jwt()`
   - Extracts user ID from token
   - Checks if user exists in `public.users`

3. **If user doesn't exist** in `public.users`:
   - `sync_user_from_supabase()` is called
   - User created in `public.users` with same ID
   - User metadata synced from JWT payload

4. **User is returned** to route handler

---

## Environment Variables

No changes needed! You already have:

```bash
SUPABASE_URL=https://ekttjvqjkvvpavewsxhb.supabase.co
SUPABASE_PUBLISHABLE_KEY=sb_publishable_...
SUPABASE_SECRET_KEY=sb_secret_...
```

---

## Testing

### Manual Testing

1. **Sign up via Supabase** (frontend or Supabase dashboard)
2. **Get access token** from Supabase session
3. **Call protected endpoint**:
   ```bash
   curl -H "Authorization: Bearer <supabase_token>" \
        http://localhost:8000/api/routines/
   ```

### Automated Tests

Tests need to be updated to:
- Use Supabase test tokens (or mock Supabase client)
- Test user sync functionality
- Test token validation

---

## Migration Checklist

- [x] Update `dependencies.py` to use Supabase JWT validation
- [x] Create `supabase_auth.py` for token verification
- [x] Add `sync_user_from_supabase()` to UserService
- [x] Remove custom auth routes (signup/login)
- [ ] Update tests for Supabase Auth
- [ ] Update frontend to use Supabase client
- [ ] Test end-to-end flow

---

## Next Steps

1. **Frontend Integration**
   - Install `@supabase/supabase-js`
   - Replace custom auth with Supabase client
   - Update API calls to include Supabase tokens

2. **Testing**
   - Test signup/login flow
   - Test protected routes
   - Test user sync

3. **Optional Features**
   - Enable email verification
   - Add OAuth providers (Google, GitHub)
   - Configure password reset emails

---

## Resources

- [Supabase Auth Docs](https://supabase.com/docs/guides/auth)
- [Supabase Python Client](https://github.com/supabase/supabase-py)
- [JWT Validation Guide](https://supabase.com/docs/guides/auth/jwts)

---

**Migration completed!** Backend is ready for Supabase Auth. üöÄ
